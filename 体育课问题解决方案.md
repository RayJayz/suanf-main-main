# 体育课教室问题解决方案

## 问题描述

体育课（PHYE000111 体育Ⅰ、PHYE000311 体育Ⅲ、PHYE000511 体育健康课程Ⅰ）应该在室外场地（体育场/体育馆）上课，但当前系统将其分配到了普通室内教室。

## 根本原因

1. **缺少体育场地数据**：数据库中没有定义体育场（北区体育场、南区体育场）和体育馆
2. **缺少课程特征要求**：没有明确指定体育课必须在室外（SW）场地上课
3. **排课算法未限制**：遗传算法在选择教室时，没有强制体育课使用室外场地

## 完整解决方案

### 方案A：数据库层面解决（推荐★★★★★）

这是最优雅和可维护的方案。

#### 1. 执行SQL脚本

```bash
# 方式1：命令行执行
mysql -u root -p paike2 < fix_pe_courses.sql

# 方式2：MySQL客户端
mysql -u root -p
use paike2;
source fix_pe_courses.sql;
```

#### 2. SQL脚本做了什么

✅ **添加室外特征** (feature_id='SW')
- 确保 classroom_features 表中有"室外"特征

✅ **创建体育场地**
- 北区体育场 (SPORT_N): 容量500人
- 南区体育场 (SPORT_S): 容量500人  
- 体育馆1 (GYM_1): 容量200人
- 体育馆2 (GYM_2): 容量200人

✅ **标记场地特征**
- 所有体育场地都标记为"室外"(SW)特征

✅ **创建课程特征要求表** (如果不存在)
```sql
CREATE TABLE course_required_features (
    course_id VARCHAR(20) NOT NULL,
    feature_id VARCHAR(20) NOT NULL,
    is_mandatory TINYINT(1) DEFAULT 1,
    PRIMARY KEY (course_id, feature_id)
);
```

✅ **设置体育课要求**
- PHYE000111 必须在SW场地
- PHYE000311 必须在SW场地
- PHYE000511 必须在SW场地

#### 3. 重新排课

执行完SQL后，重新运行排课程序：

```bash
# 生成新版本排课
python suan2.py --version 2 --population 200 --generations 300

# 或者调整现有版本
python analyze_conflicts.py 1
# 选择优化，系统会自动将体育课调整到体育场地
```

### 方案B：代码层面增强（辅助方案）

如果方案A无法完全解决，可以在代码中添加额外的硬约束。

#### 在 `genetic_algorithm.py` 中添加体育课检查

在 `create_individual` 方法中添加：

```python
def create_individual(self) -> List[Gene]:
    """创建一个个体（染色体）"""
    genes = []
    
    # ... 现有代码 ...
    
    for task in tasks:
        # 特殊处理：体育课必须在室外场地
        if task.offering and task.offering.course_id.startswith('PHYE'):
            # 筛选出室外场地
            outdoor_classrooms = [
                cr for cr in available_classrooms 
                if 'SW' in cr.features or 'SPORT' in cr.classroom_id or 'GYM' in cr.classroom_id
            ]
            
            if outdoor_classrooms:
                available_classrooms = outdoor_classrooms
            else:
                # 如果没有室外场地，记录警告
                logger.warning(f"体育课 {task.offering.course_id} 没有可用的室外场地！")
```

#### 在适应度函数中增加惩罚

在 `_check_feature_violation` 方法中：

```python
def _check_feature_violation(self, individual: List[Gene]) -> float:
    penalty = 0
    
    for gene in individual:
        task = self.task_dict[gene.task_id]
        
        # 体育课的特殊惩罚
        if task.offering and task.offering.course_id.startswith('PHYE'):
            classroom = self.data["classrooms"][gene.classroom_id]
            # 如果不是室外场地，给予极高惩罚
            if 'SW' not in classroom.features:
                penalty += 100000  # 极高惩罚，基本不可接受
        
        # ... 现有的特征检查代码 ...
    
    return penalty
```

### 方案C：手动调整（临时方案）

如果只是想快速调整当前排课结果：

```sql
-- 查看所有体育课的当前排课
SELECT 
    c.course_name,
    cl.class_name,
    s.week_day,
    s.start_slot,
    cr.classroom_name
FROM schedules s
JOIN teaching_tasks tt ON s.task_id = tt.task_id
JOIN course_offerings co ON tt.offering_id = co.offering_id
JOIN courses c ON co.course_id = c.course_id
JOIN offering_classes oc ON co.offering_id = oc.offering_id
JOIN classes cl ON oc.class_id = cl.class_id
JOIN classrooms cr ON s.classroom_id = cr.classroom_id
WHERE c.course_id LIKE 'PHYE%'
ORDER BY c.course_id, cl.class_name, s.week_day, s.start_slot;

-- 手动更新（示例：将某个体育课改到北区体育场）
UPDATE schedules s
JOIN teaching_tasks tt ON s.task_id = tt.task_id
JOIN course_offerings co ON tt.offering_id = co.offering_id
SET s.classroom_id = 'SPORT_N'
WHERE co.course_id = 'PHYE000111'
  AND s.week_day = 1  -- 周一
  AND s.start_slot = 3;  -- 第3节
```

## 验证解决方案

### 1. 检查体育场地是否添加成功

```sql
SELECT 
    c.classroom_id,
    c.classroom_name,
    c.capacity,
    GROUP_CONCAT(cf.feature_name) as features
FROM classrooms c
LEFT JOIN classroom_has_features chf ON c.classroom_id = chf.classroom_id
LEFT JOIN classroom_features cf ON chf.feature_id = cf.feature_id
WHERE c.classroom_id IN ('SPORT_N', 'SPORT_S', 'GYM_1', 'GYM_2')
GROUP BY c.classroom_id, c.classroom_name, c.capacity;
```

### 2. 检查课程要求是否设置成功

```sql
SELECT 
    c.course_id,
    c.course_name,
    cf.feature_name,
    crf.is_mandatory
FROM course_required_features crf
JOIN courses c ON crf.course_id = c.course_id
JOIN classroom_features cf ON crf.feature_id = cf.feature_id
WHERE c.course_id LIKE 'PHYE%';
```

### 3. 运行诊断程序

```bash
python fix_pe_courses.py
```

会显示：
- 体育课程列表
- 可用的室外场地
- 当前体育课的教室分配
- 问题统计

### 4. 查看排课结果

```bash
python view_schedule.py 1
```

检查体育课是否都在室外场地上课。

## 预期结果

✅ 所有体育课（PHYE000111, PHYE000311, PHYE000511）都被分配到：
- 北区体育场 (SPORT_N)
- 南区体育场 (SPORT_S)
- 体育馆1 (GYM_1)
- 体育馆2 (GYM_2)

✅ 排课冲突分析中不再有体育课在室内教室的警告

✅ 遗传算法的适应度分数提高（减少了特征违反惩罚）

## 常见问题

### Q1: 执行SQL后体育课还是在室内？
**A:** 需要重新运行排课程序或使用 `analyze_conflicts.py` 优化现有排课。数据库修改不会自动更新已生成的排课结果。

### Q2: 体育场地容量不够怎么办？
**A:** 可以增加更多体育场地或调整现有场地容量：
```sql
-- 增加容量
UPDATE classrooms SET capacity = 1000 WHERE classroom_id = 'SPORT_N';

-- 添加更多场地
INSERT INTO classrooms VALUES ('GYM_3', '体育馆3', '体育馆', 'DB', '体育馆', 200, 1, NOW(), NOW());
```

### Q3: 如何添加更多特殊场地（如游泳馆）？
**A:** 
```sql
-- 1. 创建新特征
INSERT INTO classroom_features VALUES ('POOL', '游泳池', '游泳教学场地');

-- 2. 添加场地
INSERT INTO classrooms VALUES ('POOL_1', '游泳馆', '游泳馆', 'DB', '游泳池', 100, 1, NOW(), NOW());

-- 3. 标记特征
INSERT INTO classroom_has_features VALUES ('POOL_1', 'POOL');

-- 4. 设置需要游泳池的课程
INSERT INTO course_required_features VALUES ('SWIM001', 'POOL', 1);
```

## 总结

**推荐方案：方案A（数据库层面）**

优点：
- ✅ 一劳永逸，所有未来排课都会遵守
- ✅ 数据驱动，易于维护和扩展
- ✅ 不需要修改代码
- ✅ 符合系统设计原则

**执行步骤：**
1. 执行 `fix_pe_courses.sql`
2. 重新运行排课或优化现有排课
3. 验证结果

如有问题，可以组合使用方案B在代码中增加额外保护。
